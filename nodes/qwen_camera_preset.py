"""
Qwen_镜头预设.py - 为Qwen模型生成相机参数提示词的ComfyUI节点

此节点允许用户通过界面控件调整相机参数，并生成相应的提示词。
支持控制相机移动、视角和镜头设置等多种参数，用于生成更精确的图像描述。

参数说明：
- 移动控制：启用或禁用移动控制
- 向上移动：控制是否启用俯视图（开关选项），提示词为"将镜头向上移动，俯视图，极端角度"
- 向下移动：控制是否启用仰视图（开关选项），提示词为"将镜头向下移动，仰视图，极端角度"
- 向左旋转：控制向左旋转的角度 (0-90度)，提示词为"将镜头向左旋转X度"
- 向右旋转：控制向右旋转的角度 (0-90度)，提示词为"将镜头向右旋转X度"
- 背面：控制是否启用背面拍摄（开关选项），提示词为"镜头从背后拍摄"
- 拉近镜头：控制拉近镜头的程度 (0-100)，达到100时提示词为"将镜头改为特写镜头"
- 镜头模式：选择相机镜头类型，生成的提示词格式为"将镜头转化为[镜头类型]"

提示词生成规则：
- 当多个参数同时生效时，第一个镜头描述前缀为"将镜头改为"，后续镜头描述用"同时"连接
- 例如："将镜头向上移动，俯视图，同时镜头向左移动50%"

输出：
- 提示词字符串：根据设置生成的相机参数描述
"""

# 导入必要的模块
import torch

# 定义节点类
class QwenCameraPresetNode:
    """
    🍰Qwen-镜头预设节点
    将相机控制参数转换为描述性提示词
    
    注意：
    - 移动控制参数已设置为滑块控制，方便直观调整
    - 通过拖动滑块可以在相应范围内调整各个参数的值
    - 只有在启用移动控制开关时，对应参数才会生效
    
    输入参数说明（按界面显示顺序）：
    - 移动控制: 开关，控制是否启用移动控制
    - 向上移动: 开关，控制是否启用俯视图，生成的提示词为"将镜头向上移动，俯视图，极端角度"
    - 向下移动: 开关，控制是否启用仰视图，生成的提示词为"将镜头向下移动，仰视图，极端角度"
    - 向左旋转: 滑块，控制向左旋转的角度 (0-90度)，生成的提示词为"将镜头向左旋转X度"
    - 向右旋转: 滑块，控制向右旋转的角度 (0-90度)，生成的提示词为"将镜头向右旋转X度"
    - 背面: 开关，控制是否启用背面拍摄，生成的提示词为"镜头从背后拍摄"
    - 拉近镜头: 滑块，控制拉近镜头的程度 (0-100)，达到100时提示词为"将镜头改为特写镜头"
    - 镜头模式: 下拉菜单，选择镜头类型，生成的提示词格式为"将镜头转化为[镜头类型]"
    
    输出：
    - 提示词: 根据输入参数生成的相机控制描述性提示词字符串
    """
    # 节点分类
    CATEGORY = "🍡Comfyui-xishen"
    
    @classmethod
    def INPUT_TYPES(s):
        """
        定义节点的输入类型
        返回一个字典，包含所有可配置的输入参数
        """
        return {
            "required": {
                # 移动控制开关
                "移动控制": ("BOOLEAN", {"default": False}),
                # 使用开关控制的视图模式
                "向上移动": ("BOOLEAN", {"default": False}),  # 开关控制俯视图
                "向下移动": ("BOOLEAN", {"default": False}),  # 开关控制仰视图
                "背面": ("BOOLEAN", {"default": False}),  # 开关控制背面拍摄
                # 使用滑块控制的旋转参数
                "向左旋转": ("INT", {"default": 0, "min": 0, "max": 90, "step": 1, "display": "slider"}),
                "向右旋转": ("INT", {"default": 0, "min": 0, "max": 90, "step": 1, "display": "slider"}),
                "拉近镜头": ("INT", {"default": 0, "min": 0, "max": 100, "step": 1, "display": "slider"}),  # 拉近镜头，100时为特写镜头
                
                # 镜头模式 - 使用专业镜头类型的参数
                "镜头模式": (["无", "标准镜头", "广角镜头", "长焦镜头", "鱼眼镜头", "微距镜头", "移轴镜头"], {"default": "标准镜头"})
            },
        }
    
    # 定义节点的输出类型
    RETURN_TYPES = ("STRING",)
    RETURN_NAMES = ("提示词",)
    
    # 定义节点的功能名称
    FUNCTION = "execute"
    
    def execute(self, 
                移动控制, 向上移动, 向下移动, 背面, 向左旋转, 向右旋转, 拉近镜头,
                镜头模式):
        """
        根据相机参数生成描述性提示词
        
        参数:
        - 移动控制: 是否启用移动控制（开关）
        - 向上移动: 控制是否启用俯视图（开关）
        - 向下移动: 控制是否启用仰视图（开关）
        - 背面: 是否启用背面拍摄（开关）
        - 向左旋转: 向左旋转的角度（滑块控制，0-90度），提示词为"将镜头向左旋转X度"
        - 向右旋转: 向右旋转的角度（滑块控制，0-90度），提示词为"将镜头向右旋转X度"
        - 拉近镜头: 拉近镜头的程度（滑块控制，0-100），达到100时提示词为"将镜头改为特写镜头"
        - 镜头模式: 相机镜头类型选择（下拉菜单）
        
        返回:
        - 提示词字符串
        """
        # 初始化提示词列表
        prompts = []
        
        # 添加镜头相关描述
        if 镜头模式 != "无":
            prompts.append(f"将镜头转化为{镜头模式}")
        
        # 处理移动控制
        if 移动控制:
            # 处理拉近镜头，100时为特写镜头
            if 拉近镜头 > 0:
                if 拉近镜头 == 100:
                    prompts.append("将镜头改为特写镜头")
                else:
                    prompts.append(f"将镜头拉近{拉近镜头}%")
            
            # 处理俯视图和仰视图（布尔开关）
            if 向上移动:
                prompts.append("将镜头向上移动，俯视图，极端角度")
            if 向下移动:
                prompts.append("将镜头向下移动，仰视图，极端角度")
            
            # 处理向左和向右旋转，统一使用旋转角度描述
            if 向左旋转 > 0:
                prompts.append(f"将镜头向左旋转{向左旋转}度")
            if 向右旋转 > 0:
                prompts.append(f"将镜头向右旋转{向右旋转}度")
            
            # 处理背面拍摄
            if 背面:
                prompts.append("镜头从背后拍摄")
        
        # 优化提示词连接逻辑
        if prompts:
            # 第一个提示词保持不变，后续提示词使用"同时"连接
            final_prompt = prompts[0]
            for prompt in prompts[1:]:
                # 如果提示词以"将镜头"开头，去掉这个前缀
                if prompt.startswith("将镜头"):
                    prompt = prompt[3:]  # 去掉"将镜头"前缀
                final_prompt += f"，同时{prompt}"
        else:
            final_prompt = ""
        
        # 返回生成的提示词
        return (final_prompt,)

# 注册节点
NODE_CLASS_MAPPINGS = {
    "🍰Qwen-镜头预设": QwenCameraPresetNode
}

# 节点显示名称映射
NODE_DISPLAY_NAME_MAPPINGS = {
    "🍰Qwen-镜头预设": "🍰Qwen-镜头预设-xishen"
}
